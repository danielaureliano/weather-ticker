<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="https://images.icon-icons.com/8/PNG/64/cloudyweather_cloud_inpart_day_wind_thunder_sunny_rain_darkness_nublad_1459.png" type="image/x-icon">
  <link rel="shortcut icon" href="https://images.icon-icons.com/8/PNG/64/cloudyweather_cloud_inpart_day_wind_thunder_sunny_rain_darkness_nublad_1459.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0c97f2">
  <meta name="description" content="Ticker de dados meteorológicos do INMET para Brasília.">
  <meta name="author" content="INMET - Instituto Nacional de Meteorologia">
  <title>Ticker Meteorologia INMET Brasília</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 125px;
      font-family: Arial, sans-serif;
      background: #f4f7fa;
    }

    #weather-ticker-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: 110px;
      z-index: 999999;
      display: flex;
      align-items: stretch;
      overflow: hidden;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.09);
    }

    #weather-title {
      width: 320px;
      min-width: 180px;
      background: #0c97f2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: 2.3rem;
      font-weight: bold;
      letter-spacing: 1.5px;
      padding-left: 36px;
      padding-right: 12px;
      border: none;
      border-right: 2px solid #2077be;
    }

    #weather-ticker {
      flex: 1;
      background: #2d3440;
      color: #fff;
      display: flex;
      align-items: center;
      overflow: hidden;
      padding-left: 36px;
      position: relative;
    }

#weather-ticker-content {
  /* display: inline-block; */ /* Linha antiga removida */
  display: flex; /* Adicionado */
  align-items: center; /* Adicionado */
  white-space: nowrap;
  font-size: 2rem;
  min-width: 100vw;
  animation: ticker-weather 40s linear infinite;
}

    @media (max-width: 800px) {
      #weather-title {
        font-size: 1.2rem;
        padding-left: 14px;
        padding-right: 6px;
      }

      #weather-ticker-content {
        font-size: 1.1rem;
      }

      #weather-ticker {
        padding-left: 8px;
      }
    }

    @media (orientation: portrait) {
      #weather-ticker-bar {
        height: 200px;
      }

      #weather-title {
        font-size: 2.1rem;
      }

      #weather-ticker-content {
        font-size: 2rem;
      }
    }

    @keyframes ticker-weather {
      0% {
        transform: translateX(100vw);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .weather-item {
      margin-right: 64px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .weather-item>img,
    .weather-item>span {
      vertical-align: middle;
      min-width: 50px;
    }

    .weather-item {
      align-items: center;
      min-height: 56px;
    }


    .weather-icon,
    .weather-icon-umid,
    .weather-icon-tmin,
    .weather-icon-tmax,
    .weather-icon-estacao,
    .weather-icon-lua {
      vertical-align: middle;
      margin-left: 1rem;
      height: 44px;
      width: 44px;
      border-radius: 25px;      
    }

    .weather-icon-small {
      width: 24px;
      height: 45px;
      margin-left: 1rem;
      vertical-align: middle;
      border-radius: 25px;
    }

    .weather-alert {
      color: #ffd600;
      font-weight: bold;
      margin-right: 50px;

      padding: 8px 22px;
      border-radius: 10px;
      background: #c70000;
      border: 2px solid #ffd600;
      font-size: 1.4rem;
      letter-spacing: 1px;
      text-shadow: 1px 1px 3px #222a;
      display: inline-block;
    }

    .weather-label {
      font-weight: bold;      
      margin-left: 8px;
    }

    .weather-day {
      color: #6dd47e;
      font-weight: bold;
      margin-right: 14px;
    }

    .weather-max,
    .weather-min {
      margin-right: 10px;
    }

    .weather-block {
      display: flex;
      flex-direction: column;
    }

    @media (orientation: portrait) {
      #weather-ticker-content {
        font-size: 2.7rem;
      }

      .weather-item {
        margin-right: 86px;
      }

      .weather-icon,
      .weather-icon-umid,
      .weather-icon-tmin,
      .weather-icon-tmax,
      .weather-icon-estacao,
      .weather-icon-lua {
        height: 60px;
        width: 60px;
      }

      .weather-icon-small {
        width: 42px;
        height: 42px;
      }
    }   
    
</style>  
</head>

<body>
  <div id="weather-ticker-bar">
    <div id="weather-title">METEOROLOGIA</div>

    <div id="weather-ticker">
      <div id="weather-ticker-content">
        Carregando dados meteorológicos...
      </div>
    </div>
  </div>

  <script>
    // Ícones oficiais
    const ICON_TMIN = "https://portal.inmet.gov.br/uploads/icones/temperatura_minima.jpg";
    const ICON_TMAX = "https://portal.inmet.gov.br/uploads/icones/temperatura_maxima.png";
    const ICON_UMAX = "https://portal.inmet.gov.br/uploads/icones/umidade_max.png";
    const ICON_UMIN = "https://portal.inmet.gov.br/uploads/icones/umidade_min.png";
    const ICON_OCASO = "https://portal.inmet.gov.br/uploads/icones/ocaso_sol.png";
    const ICON_NASCER = "https://portal.inmet.gov.br/uploads/icones/nascer_sol.png";
    const ICON_SEN = "https://portal.inmet.gov.br/uploads/icones/sensa%C3%A7%C3%A3o.png";
    const ICON_WIND = "https://portal.inmet.gov.br/uploads/icones/wind.png";
    const ICON_CHUVA = "https://portal.inmet.gov.br/uploads/icones/precipta%C3%A7%C3%A3o.png";
    const ICON_ESTACAO = (estacao) => estacao ? `https://portal.inmet.gov.br/uploads/seasons/${capitalize(estacao)}.png` : ''; // Ícone de estação vazio se não houver estação
    const ICON_LUA = (num) => `https://portal.inmet.gov.br/uploads/luas/${num}.png`;
    const ICON_UMID = ICON_UMAX;
    const ICON_TEMP = ICON_TMAX;

    const codigoIBGE = "5300108"; // Brasília

    // Calendário da Lua 2025 (IAG/USP)
    const moonPhases2025 = [
        { date: "2025-01-29", phase: "Nova" }, { date: "2025-01-06", phase: "Crescente" }, { date: "2025-01-13", phase: "Cheia" }, { date: "2025-01-21", phase: "Minguante" },
        { date: "2025-02-27", phase: "Nova" }, { date: "2025-02-05", phase: "Crescente" }, { date: "2025-02-12", phase: "Cheia" }, { date: "2025-02-20", phase: "Minguante" },
        { date: "2025-03-29", phase: "Nova" }, { date: "2025-03-06", phase: "Crescente" }, { date: "2025-03-14", phase: "Cheia" }, { date: "2025-03-22", phase: "Minguante" },
        { date: "2025-04-27", phase: "Nova" }, { date: "2025-04-04", phase: "Crescente" }, { date: "2025-04-12", phase: "Cheia" }, { date: "2025-04-20", phase: "Minguante" },
        { date: "2025-05-27", phase: "Nova" }, { date: "2025-05-04", phase: "Crescente" }, { date: "2025-05-12", phase: "Cheia" }, { date: "2025-05-20", phase: "Minguante" },
        { date: "2025-06-25", phase: "Nova" }, { date: "2025-06-03", phase: "Crescente" }, { date: "2025-06-11", phase: "Cheia" }, { date: "2025-06-18", phase: "Minguante" },
        { date: "2025-07-24", phase: "Nova" }, { date: "2025-07-02", phase: "Crescente" }, { date: "2025-07-10", phase: "Cheia" }, { date: "2025-07-17", phase: "Minguante" },
        { date: "2025-08-23", phase: "Nova" }, { date: "2025-08-01", phase: "Crescente" }, { date: "2025-08-09", phase: "Cheia" }, { date: "2025-08-16", phase: "Minguante" },
        { date: "2025-09-21", phase: "Nova" }, { date: "2025-08-31", phase: "Crescente" }, { date: "2025-09-07", phase: "Cheia" }, { date: "2025-09-14", phase: "Minguante" },
        { date: "2025-10-21", phase: "Nova" }, { date: "2025-09-29", phase: "Crescente" }, { date: "2025-10-07", phase: "Cheia" }, { date: "2025-10-13", phase: "Minguante" },
        { date: "2025-11-20", phase: "Nova" }, { date: "2025-10-29", phase: "Crescente" }, { date: "2025-11-05", phase: "Cheia" }, { date: "2025-11-12", phase: "Minguante" },
        { date: "2025-12-19", phase: "Nova" }, { date: "2025-11-28", phase: "Crescente" }, { date: "2025-12-04", phase: "Cheia" }, { date: "2025-12-11", phase: "Minguante" },
        { date: "2025-12-27", phase: "Crescente" }
    ].sort((a, b) => a.date.localeCompare(b.date));

    // ATUALIZADO: Mapeamento para as 8 fases da lua
    const phaseToIconMap = {
        'Nova': 0, 'Crescente Côncava': 1, 'Quarto Crescente': 2, 'Crescente Gibosa': 3,
        'Cheia': 4, 'Minguante Gibosa': 5, 'Quarto Minguante': 6, 'Minguante Côncava': 7
    };
    
    // Função para calcular a diferença em dias entre duas datas YYYY-MM-DD
    const dayDiff = (dateStr1, dateStr2) => {
        const d1 = new Date(dateStr1 + "T12:00:00Z"); // Usar UTC para evitar problemas de fuso
        const d2 = new Date(dateStr2 + "T12:00:00Z");
        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    };

    // Função da Lua com a nova lógica de negócio
    function getFaseLua(forecastDateString) {
        const currentYear = forecastDateString.substring(0, 4);
        if (currentYear !== '2025') {
            return { name: "Ano não suportado", iconUrl: ICON_LUA(4) };
        }
        
        let lastPhase = null, nextPhase = null;
        for (let i = 0; i < moonPhases2025.length; i++) {
            if (moonPhases2025[i].date <= forecastDateString) {
                lastPhase = moonPhases2025[i];
            } else {
                nextPhase = moonPhases2025[i];
                break;
            }
        }
        
        if (!lastPhase) lastPhase = moonPhases2025[0];

        let currentPhaseName = lastPhase.phase;

        // REGRA 1: Se a próxima fase for "amanhã", antecipa o nome.
        if (nextPhase && dayDiff(forecastDateString, nextPhase.date) === 1) {
            currentPhaseName = nextPhase.phase === 'Crescente' ? 'Quarto Crescente' : 
                               nextPhase.phase === 'Minguante' ? 'Quarto Minguante' : nextPhase.phase;
        } 
        // REGRA 2: Se hoje é o dia exato de uma fase principal.
        else if (lastPhase.date === forecastDateString) {
            currentPhaseName = lastPhase.phase === 'Crescente' ? 'Quarto Crescente' : 
                               lastPhase.phase === 'Minguante' ? 'Quarto Minguante' : lastPhase.phase;
        }
        // REGRA 3: Se for um dia intermediário (não é véspera nem dia exato).
        else {
            switch (lastPhase.phase) {
                case 'Nova': currentPhaseName = 'Crescente Côncava'; break;
                case 'Crescente': currentPhaseName = 'Crescente Gibosa'; break;
                case 'Cheia': currentPhaseName = 'Minguante Gibosa'; break;
                case 'Minguante': currentPhaseName = 'Minguante Côncava'; break;
            }
        }
        
        const iconNumber = phaseToIconMap[currentPhaseName] ?? 4; 
        
        return {
            iconUrl: ICON_LUA(iconNumber),
            name: currentPhaseName
        };
    }

    function capitalize(str) {
      return str && typeof str === "string" ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : "";
    }

    function safe(val, unit = "") {
      return val !== undefined && val !== null && val !== "" ? val + unit : "--";
    }

    async function fetchJsonOrText(url) {
      const resp = await fetch(url);
      const text = await resp.text();
      try { return JSON.parse(text); }
      catch { throw new Error(text); }
    }

    function getCachedData(key, maxMinutes) {
      const item = localStorage.getItem(key);
      if (!item) return null;
      try {
        const { data, timestamp } = JSON.parse(item);
        const ageMinutes = (Date.now() - timestamp) / 1000 / 60;
        if (ageMinutes > maxMinutes) return null;
        return data;
      } catch { return null; }
    }

    function setCachedData(key, data) {
      localStorage.setItem( key, JSON.stringify({ data, timestamp: Date.now() }) );
    }

async function loadWeatherData() {
  const urlPrev = `https://apiprevmet3.inmet.gov.br/previsao/${codigoIBGE}`;
  const urlAvisos = `https://apiprevmet3.inmet.gov.br/avisos/${codigoIBGE}`;
  const urlAgora = `https://apiprevmet3.inmet.gov.br/estacao/proxima/${codigoIBGE}`;
  let tickerHtml = "";

  try {
        // ... (Bloco de Alertas e Tempo Agora permanece o mesmo) ...
    let alerts;
    try {
      alerts = getCachedData("inmet_alertas", 30);
      if (!alerts) {
        alerts = await fetchJsonOrText(urlAvisos);
        setCachedData("inmet_alertas", alerts);
      }
      if (
        alerts &&
        alerts[codigoIBGE] &&
        Array.isArray(alerts[codigoIBGE]) &&
        alerts[codigoIBGE].length > 0
      ) {
        alerts[codigoIBGE].forEach((alerta) => {
          tickerHtml += `<span class="weather-alert">
    ⚠️ ${safe(alerta.tipo)} - ${safe(alerta.titulo)}: ${safe(alerta.texto)}
    </span>`;
        });
      }
    } catch (e) {
      console.warn("Avisos não disponíveis:", e.message);
    }

    // TEMPO AGORA (cache 30min)
    let dadosObj = getCachedData("inmet_agora", 30);
    if (!dadosObj) {
      dadosObj = await fetchJsonOrText(urlAgora);
      setCachedData("inmet_agora", dadosObj);
    }
    let dado = dadosObj.dados || {};

    tickerHtml += `<span class="weather-item">
                <img src="${ICON_TEMP}" class="weather-icon-tmax" alt="Temperatura atual">
                <span class="weather-label">Agora:</span>
                ${safe(dado.TEM_INS, "°C")}
                <img src="${ICON_SEN}" class="weather-icon-small" alt="Sensação térmica">
                Sensação: ${safe(dado.TEM_SEN, "°C")}
                <img src="${ICON_UMID}" class="weather-icon-umid" alt="Umidade">
                UMD: ${safe(dado.UMD_INS, "%")}
                <img src="${ICON_CHUVA}" class="weather-icon-small" alt="Chuva">
                Chuva: ${safe(dado.CHUVA, " mm")}
                <img src="${ICON_WIND}" class="weather-icon-small" alt="Vento">
                Vento: ${safe(dado.VEN_VEL, " m/s")} (${safe(
      dado.VEN_RAJ,
      " m/s"
    )})
                </span>`;

    // PREVISÃO DO TEMPO (hoje + próximos 3 dias) (cache 60min)
    let data = getCachedData("inmet_previsao", 60);
    if (!data) {
      data = await fetchJsonOrText(urlPrev);
      setCachedData("inmet_previsao", data);
    }

    const br = data && data[codigoIBGE] ? data[codigoIBGE] : {};
    const diasKeys = Object.keys(br).sort((a, b) => {
      const [da, ma, ya] = a.split('/').map(Number);
      const [db, mb, yb] = b.split('/').map(Number);
      return ya - yb || ma - mb || da - db;
    });
        if (!diasKeys.length) throw new Error("Sem dados de previsão para Brasília");

    const hoje = br[diasKeys[0]];
        
        // --- CORREÇÃO APLICADA AQUI ---
        // 1. Criar a string da data da previsão no formato YYYY-MM-DD
        const [d, m, y] = diasKeys[0].split('/');
        const forecastDateString = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        
        // 2. Calcular a fase da lua e obter o ícone da estação
        const faseLua = getFaseLua(forecastDateString);
        const iconEstacao = ICON_ESTACAO(hoje.manha.estacao);
        // Não há mais declarações duplicadas aqui.

    // Previsão do dia
    tickerHtml += `<span class="weather-item">
                <span class="weather-day">Previsão do dia:</span>
                <span>${safe(hoje.manha.resumo)}</span> <img src="${ICON_TMAX}" class="weather-icon-tmax" alt="Temp. Máx.">Máxima: <span class="weather-max">${safe(
      hoje.manha.temp_max,
      "°C"
    )}</span>
                <img src="${ICON_TMIN}" class="weather-icon-tmin" alt="Temp. Mín.">Mínima: <span class="weather-min">${safe(
      hoje.manha.temp_min,
      "°C"
    )}</span>
                <img src="${ICON_UMAX}" class="weather-icon-umid" alt="Umidade Máx.">Umd. Máx.: <span>${safe(
      hoje.manha.umidade_max,
      "%"
    )}</span>
                <img src="${ICON_UMIN}" class="weather-icon-umid" alt="Umidade Mín.">Umd. Mín.: <span>${safe(
      hoje.manha.umidade_min,
      "%"
    )}</span>
                <img src="${ICON_NASCER}" class="weather-icon-small" alt="Nascer do Sol">
                    Nascer do Sol: ${safe(hoje.manha.nascer)}
                <img src="${ICON_OCASO}" class="weather-icon-small" alt="Pôr do Sol">
                    Pôr do Sol: ${safe(hoje.manha.ocaso)}
                <span class="weather-label">Estação:</span>
                    <img src="${iconEstacao}" class="weather-icon-estacao" alt="Estação" title="${safe(hoje.manha.estacao)}">
                    <span>${safe(hoje.manha.estacao)}</span>
                <span class="weather-label">Lua:</span>
                    <img src="${faseLua.iconUrl}" class="weather-icon-lua" alt="Lua" title="${safe(faseLua.name)}">
                    <span>${safe(faseLua.name)}</span>
                </span>`;

        // Previsão períodos de hoje
    ["manha", "tarde", "noite"].forEach((periodo) => {
      if (hoje[periodo]) {
        tickerHtml += `<span class="weather-item">
                            <img src="${hoje[periodo].icone}" class="weather-icon" alt="${periodo}">
                            <span class="weather-day">${capitalize(periodo)}:</span>
                        ${safe(hoje[periodo].resumo)},
                            Vento: ${safe(hoje[periodo].int_vento)} (${safe(hoje[periodo].dir_vento)})
                        </span>`;
      }
    });

    // Próximos 3 dias
    for (let i = 1; i < 4 && i < diasKeys.length; i++) {
      const dia = br[diasKeys[i]];
      const previsao = dia.manha || dia;
          const umidadeMax = dia.umidade_max || previsao.umidade_max;
          const umidadeMin = dia.umidade_min || previsao.umidade_min;

          // Calcula a fase da lua para cada dia da previsão
          const [d_loop, m_loop, y_loop] = diasKeys[i].split('/');
          const forecastDateString_loop = `${y_loop}-${m_loop.padStart(2, '0')}-${d_loop.padStart(2, '0')}`;
          const faseLuaDia = getFaseLua(forecastDateString_loop);

      tickerHtml += `<span class="weather-item">
                    <span class="weather-day">${safe(
        previsao.dia_semana || dia.dia_semana
      )}:</span>
                    <img src="${previsao.icone}" class="weather-icon" alt="${safe(previsao.dia_semana || dia.dia_semana)}">
                    <span>${safe(previsao.resumo)}</span> <img src="${ICON_TMAX}" class="weather-icon-tmax" alt="Temp. Máx">Máxima: <span class="weather-max">${safe(
          previsao.temp_max,
          "°C"
        )}</span>
                    <img src="${ICON_TMIN}" class="weather-icon-tmin" alt="Temp. Mín">Mínima: <span class="weather-min">${safe(
          previsao.temp_min,
          "°C"
        )}</span>
                    <img src="${ICON_UMAX}" class="weather-icon-umid" alt="Umidade Max">Umd. Máx.: <span>${safe(
          previsao.umidade_max, // Corrigido: sempre buscar do objeto 'dia'
          "%"
        )}</span>
                    <img src="${ICON_UMIN}" class="weather-icon-umid" alt="Umidade Min">Umd. Mín.: <span>${safe(
          previsao.umidade_min, // Corrigido: sempre buscar do objeto 'dia'
          "%"
        )}</span>
                    <img src="${ICON_WIND}" class="weather-icon-small" alt="Vento">Vento: ${safe(previsao.int_vento)} (${safe(previsao.dir_vento)}) 
                        <span class="weather-label">Lua:</span>
                        <img src="${faseLuaDia.iconUrl}" class="weather-icon-lua" alt="Lua" title="${safe(faseLuaDia.name)}">
                        <span>${safe(faseLuaDia.name)}</span>
                  </span>`;
    }
  } catch (e) {
    tickerHtml =
      "Erro ao carregar informações meteorológicas. " + (e.message || e);
    console.error(e);
  }

  document.getElementById("weather-ticker-content").innerHTML =
    tickerHtml;

  const ticker = document.getElementById("weather-ticker-content");
  ticker.style.animation = "none";
  ticker.style.minWidth = "unset";
  setTimeout(() => {
    const tickerWidth = ticker.scrollWidth;
    const parentWidth = ticker.parentElement.offsetWidth;
    const speedPxPerSec = 140; // Velocidade fixa de 140px/s
    const duration = (tickerWidth + parentWidth) / speedPxPerSec;
    const keyframesName = "ticker-weather-dyn";
    const styleElem = document.getElementById("ticker-style-dyn") || (() => {
      const style = document.createElement("style");
      style.id = "ticker-style-dyn";
      document.head.appendChild(style);
      return style;
    })();
        styleElem.innerHTML = `@keyframes ${keyframesName} { 0% { transform: translateX(${parentWidth}px); } 100% { transform: translateX(-${tickerWidth}px); } }`;
    ticker.style.animation = `${keyframesName} ${duration}s linear infinite`;
  }, 30);
}

document.addEventListener("DOMContentLoaded", () => {
  loadWeatherData(); // Carrega os dados na primeira vez

  // Lógica para pausar a animação com o mouse
  const tickerBar = document.getElementById("weather-ticker-bar");
  const tickerContent = document.getElementById("weather-ticker-content");

  if (tickerBar && tickerContent) {
    tickerBar.addEventListener("mouseenter", () => {
      tickerContent.style.animationPlayState = "paused";
    });

    tickerBar.addEventListener("mouseleave", () => {
      tickerContent.style.animationPlayState = "running";
    });
  }
});

// Atualiza os dados a cada 30 minutos
setInterval(loadWeatherData, 30 * 60 * 1000);

  </script>
</body>

</html>