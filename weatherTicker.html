<!--
  weatherTicker.html

  Ticker Meteorologia INMET Brasília

  Descrição:
  -----------
  Este arquivo HTML implementa um ticker fixo na parte inferior da página que exibe informações meteorológicas em tempo real para Brasília, utilizando dados oficiais do INMET (Instituto Nacional de Meteorologia). O ticker mostra alertas meteorológicos, condições atuais, previsão do dia e dos próximos três dias, além de ícones representativos para temperatura, umidade, vento, chuva, estação do ano e fase da lua.

  Principais Funcionalidades:
  ---------------------------
  - Exibe alertas meteorológicos ativos para Brasília.
  - Mostra dados atuais da estação meteorológica mais próxima (temperatura, sensação térmica, umidade, chuva, vento).
  - Apresenta previsão detalhada para o dia (máxima, mínima, umidade, nascer/pôr do sol, estação, lua).
  - Lista previsões resumidas para os próximos três dias.
  - Utiliza ícones oficiais do INMET para melhor visualização dos dados.
  - Animação de ticker horizontal com pausa ao passar o mouse.
  - Responsivo para diferentes tamanhos de tela e orientação (paisagem/retrato).
  - Cache local dos dados para reduzir requisições e acelerar carregamento.

  Estrutura do Código:
  --------------------
  - <style>: Define o layout, cores, animações e responsividade do ticker.
  - <body>: Contém a barra do ticker com título e área de exibição dos dados.
  - <script>:
      - Define URLs e funções utilitárias para manipulação de dados e ícones.
      - Funções para buscar e cachear dados meteorológicos e alertas via API do INMET.
      - Função principal `loadWeatherData` que monta o HTML do ticker dinamicamente.
      - Ajuste dinâmico da velocidade da animação conforme o tamanho do conteúdo.
      - Evento DOMContentLoaded para iniciar o carregamento dos dados ao abrir a página.

  Observações:
  ------------
  - O ticker é otimizado para uso em sites públicos, painéis e dashboards.
  - O código utiliza apenas JavaScript puro (sem dependências externas).
  - Os dados são atualizados automaticamente ao recarregar a página, respeitando o cache local.
  - Para alterar a cidade, basta modificar o valor da variável `codigoIBGE`.

  Autor:
  ------
  Daniel Aureliano

  Última atualização: 16/06/2025
-->
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="https://portal.inmet.gov.br/uploads/icones/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="https://portal.inmet.gov.br/uploads/icones/favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0c97f2">
  <meta name="description" content="Ticker de dados meteorológicos do INMET para Brasília.">
  <meta name="author" content="INMET - Instituto Nacional de Meteorologia">
  <title>Ticker Meteorologia INMET Brasília</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 125px;
      font-family: Arial, sans-serif;
      background: #f4f7fa;
    }

    #weather-ticker-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: 110px;
      z-index: 999999;
      display: flex;
      align-items: stretch;
      overflow: hidden;
      border-radius: 6px 6px 0 0;
      box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.09);
    }

    #weather-title {
      width: 320px;
      min-width: 180px;
      background: #0c97f2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: 2.3rem;
      font-weight: bold;
      letter-spacing: 1.5px;
      padding-left: 36px;
      padding-right: 12px;
      border: none;
      border-right: 2px solid #2077be;
    }

    #weather-ticker {
      flex: 1;
      background: #2d3440;
      color: #fff;
      display: flex;
      align-items: center;
      overflow: hidden;
      padding-left: 36px;
      position: relative;
    }

#weather-ticker-content {
  /* display: inline-block; */ /* Linha antiga removida */
  display: flex; /* Adicionado */
  align-items: center; /* Adicionado */
  white-space: nowrap;
  font-size: 2rem;
  min-width: 100vw;
  animation: ticker-weather 40s linear infinite;
}

    @media (max-width: 800px) {
      #weather-title {
        font-size: 1.2rem;
        padding-left: 14px;
        padding-right: 6px;
      }

      #weather-ticker-content {
        font-size: 1.1rem;
      }

      #weather-ticker {
        padding-left: 8px;
      }
    }

    @media (orientation: portrait) {
      #weather-ticker-bar {
        height: 200px;
      }

      #weather-title {
        font-size: 2.1rem;
      }

      #weather-ticker-content {
        font-size: 2rem;
      }
    }

    @keyframes ticker-weather {
      0% {
        transform: translateX(100vw);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .weather-item {
      margin-right: 64px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .weather-item>img,
    .weather-item>span {
      vertical-align: middle;
      min-width: 50px;
    }

    .weather-item {
      align-items: center;
      min-height: 56px;
    }


    .weather-icon,
    .weather-icon-umid,
    .weather-icon-tmin,
    .weather-icon-tmax,
    .weather-icon-estacao,
    .weather-icon-lua {
      vertical-align: middle;
      margin-left: 1rem;
      height: 44px;
      width: 44px;

      border-radius: 6px;
      background: #fff3;
    }

    .weather-icon-small {
      width: 32px;
      height: 32px;
      margin-left: 1rem;
      vertical-align: middle;
    }

    .weather-alert {
      color: #ffd600;
      font-weight: bold;
      margin-right: 50px;

      padding: 8px 22px;
      border-radius: 10px;
      background: #c70000;
      border: 2px solid #ffd600;
      font-size: 1.4rem;
      letter-spacing: 1px;
      text-shadow: 1px 1px 3px #222a;
      display: inline-block;
    }

    .weather-label {
      font-weight: bold;
      margin-right: 3px;
    }

    .weather-day {
      color: #6dd47e;
      font-weight: bold;
      margin-right: 14px;
    }

    .weather-max,
    .weather-min {
      margin-right: 10px;
    }

    .weather-block {
      display: flex;
      flex-direction: column;
    }

    @media (orientation: portrait) {
      #weather-ticker-content {
        font-size: 2.7rem;
      }

      .weather-item {
        margin-right: 86px;
      }

      .weather-icon,
      .weather-icon-umid,
      .weather-icon-tmin,
      .weather-icon-tmax,
      .weather-icon-estacao,
      .weather-icon-lua {
        height: 60px;
        width: 60px;
      }

      .weather-icon-small {
        width: 42px;
        height: 42px;
      }
    }
    
    /* Adicionado para pausar a animação ao passar o mouse */
    #weather-ticker-bar:hover #weather-ticker-content {
        animation-play-state: paused;
    }
</style>  
</head>

<body>
  <div id="weather-ticker-bar">
    <div id="weather-title">METEOROLOGIA</div>

    <div id="weather-ticker">
      <div id="weather-ticker-content">
        Carregando dados meteorológicos...
      </div>
    </div>
  </div>

  <script>
    // Ícones oficiais
    const ICON_TMIN = "https://portal.inmet.gov.br/uploads/icones/temperatura_minima.jpg";
    const ICON_TMAX = "https://portal.inmet.gov.br/uploads/icones/temperatura_maxima.png";
    const ICON_UMAX = "https://portal.inmet.gov.br/uploads/icones/umidade_max.png";
    const ICON_UMIN = "https://portal.inmet.gov.br/uploads/icones/umidade_min.png";
    const ICON_OCASO = "https://portal.inmet.gov.br/uploads/icones/ocaso_sol.png";
    const ICON_NASCER = "https://portal.inmet.gov.br/uploads/icones/nascer_sol.png";
    const ICON_SEN = "https://portal.inmet.gov.br/uploads/icones/sensa%C3%A7%C3%A3o.png";
    const ICON_WIND = "https://portal.inmet.gov.br/uploads/icones/wind.png";
    const ICON_CHUVA = "https://portal.inmet.gov.br/uploads/icones/precipta%C3%A7%C3%A3o.png";
    const ICON_ESTACAO = (estacao) => `https://portal.inmet.gov.br/uploads/seasons/${capitalize(estacao)}.png`;
    const ICON_LUA = (num) => `https://portal.inmet.gov.br/uploads/luas/${num}.png`;
    const ICON_UMID = ICON_UMAX;
    const ICON_TEMP = ICON_TMAX;

    const codigoIBGE = "5300108"; // Brasília

    // Dados das fases da lua para 2025 (IAG/USP)
    const moonPhases2025 = [
        { date: "2025-01-06", phase: "Minguante" }, { date: "2025-01-13", phase: "Nova" },
        { date: "2025-01-21", phase: "Crescente" }, { date: "2025-01-28", phase: "Cheia" },
        { date: "2025-02-05", phase: "Minguante" }, { date: "2025-02-12", phase: "Nova" },
        { date: "2025-02-19", phase: "Crescente" }, { date: "2025-02-27", phase: "Cheia" },
        { date: "2025-03-07", phase: "Minguante" }, { date: "2025-03-14", phase: "Nova" },
        { date: "2025-03-21", phase: "Crescente" }, { date: "2025-03-28", phase: "Cheia" },
        { date: "2025-04-05", phase: "Minguante" }, { date: "2025-04-12", phase: "Nova" },
        { date: "2025-04-19", phase: "Crescente" }, { date: "2025-04-27", phase: "Cheia" },
        { date: "2025-05-05", phase: "Minguante" }, { date: "2025-05-11", phase: "Nova" },
        { date: "2025-05-19", phase: "Crescente" }, { date: "2025-05-27", phase: "Cheia" },
        { date: "2025-06-03", phase: "Minguante" }, { date: "2025-06-10", phase: "Nova" },
        { date: "2025-06-18", phase: "Crescente" }, { date: "2025-06-25", phase: "Cheia" },
        { date: "2025-07-02", phase: "Minguante" }, { date: "2025-07-10", phase: "Nova" },
        { date: "2025-07-17", phase: "Crescente" }, { date: "2025-07-25", phase: "Cheia" },
        { date: "2025-08-01", phase: "Minguante" }, { date: "2025-08-08", phase: "Nova" },
        { date: "2025-08-16", phase: "Crescente" }, { date: "2025-08-24", phase: "Cheia" },
        { date: "2025-08-30", phase: "Minguante" }, { date: "2025-09-07", phase: "Nova" },
        { date: "2025-09-15", phase: "Crescente" }, { date: "2025-09-22", phase: "Cheia" },
        { date: "2025-09-29", phase: "Minguante" }, { date: "2025-10-07", phase: "Nova" },
        { date: "2025-10-14", phase: "Crescente" }, { date: "2025-10-22", phase: "Cheia" },
        { date: "2025-10-28", phase: "Minguante" }, { date: "2025-11-05", phase: "Nova" },
        { date: "2025-11-13", phase: "Crescente" }, { date: "2025-11-20", phase: "Cheia" },
        { date: "2025-11-27", phase: "Minguante" }, { date: "2025-12-05", phase: "Nova" },
        { date: "2025-12-13", phase: "Crescente" }, { date: "2025-12-20", phase: "Cheia" },
        { date: "2025-12-27", phase: "Minguante" }
    ];

    const phaseToIconMap = { 'Nova': 0, 'Crescente': 2, 'Cheia': 4, 'Minguante': 6 };

    function getFaseLua(forecastDate) {
        let lastPhase = moonPhases2025[0];
        for (const phase of moonPhases2025) {
            const [y, m, d] = phase.date.split('-').map(Number);
            const phaseDate = new Date(y, m - 1, d);
            if (phaseDate <= forecastDate) {
                lastPhase = phase;
            } else {
                break;
            }
        }
        
        const iconNumber = phaseToIconMap[lastPhase.phase] ?? 4; 
        
        return {
            iconUrl: ICON_LUA(iconNumber),
            name: lastPhase.phase
        };
    }

    function capitalize(str) {
      return str && typeof str === "string" ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : "";
    }

    function safe(val, unit = "") {
      return val !== undefined && val !== null && val !== "" ? val + unit : "--";
    }

    async function fetchJsonOrText(url) {
      const resp = await fetch(url);
      const text = await resp.text();
      try { return JSON.parse(text); }
      catch { throw new Error(text); }
    }

    function getCachedData(key, maxMinutes) {
      const item = localStorage.getItem(key);
      if (!item) return null;
      try {
        const { data, timestamp } = JSON.parse(item);
        const ageMinutes = (Date.now() - timestamp) / 1000 / 60;
        if (ageMinutes > maxMinutes) return null;
        return data;
      } catch { return null; }
    }

    function setCachedData(key, data) {
      localStorage.setItem( key, JSON.stringify({ data, timestamp: Date.now() }) );
    }

async function loadWeatherData() {
  const urlPrev = `https://apiprevmet3.inmet.gov.br/previsao/${codigoIBGE}`;
  const urlAvisos = `https://apiprevmet3.inmet.gov.br/avisos/${codigoIBGE}`;
  const urlAgora = `https://apiprevmet3.inmet.gov.br/estacao/proxima/${codigoIBGE}`;
  let tickerHtml = "";

  try {
        // ... (Bloco de Alertas e Tempo Agora permanece o mesmo) ...
    let alerts;
    try {
      alerts = getCachedData("inmet_alertas", 30);
      if (!alerts) {
        alerts = await fetchJsonOrText(urlAvisos);
        setCachedData("inmet_alertas", alerts);
      }
      if (
        alerts &&
        alerts[codigoIBGE] &&
        Array.isArray(alerts[codigoIBGE]) &&
        alerts[codigoIBGE].length > 0
      ) {
        alerts[codigoIBGE].forEach((alerta) => {
          tickerHtml += `<span class="weather-alert">
    ⚠️ ${safe(alerta.tipo)} - ${safe(alerta.titulo)}: ${safe(alerta.texto)}
    </span>`;
        });
      }
    } catch (e) {
      console.warn("Avisos não disponíveis:", e.message);
    }

    // TEMPO AGORA (cache 30min)
    let dadosObj = getCachedData("inmet_agora", 30);
    if (!dadosObj) {
      dadosObj = await fetchJsonOrText(urlAgora);
      setCachedData("inmet_agora", dadosObj);
    }
    let dado = dadosObj.dados || {};

    tickerHtml += `<span class="weather-item">
                <img src="${ICON_TEMP}" class="weather-icon-tmax" alt="Temperatura atual">
                <span class="weather-label">Agora:</span>
                ${safe(dado.TEM_INS, "°C")}
                <img src="${ICON_SEN}" class="weather-icon-small" alt="Sensação térmica">
                Sensação: ${safe(dado.TEM_SEN, "°C")}
                <img src="${ICON_UMID}" class="weather-icon-umid" alt="Umidade">
                UMD: ${safe(dado.UMD_INS, "%")}
                <img src="${ICON_CHUVA}" class="weather-icon-small" alt="Chuva">
                Chuva: ${safe(dado.CHUVA, " mm")}
                <img src="${ICON_WIND}" class="weather-icon-small" alt="Vento">
                Vento: ${safe(dado.VEN_VEL, " m/s")} (${safe(
      dado.VEN_RAJ,
      " m/s"
    )})
                </span>`;

    // PREVISÃO DO TEMPO (hoje + próximos 3 dias) (cache 60min)
    let data = getCachedData("inmet_previsao", 60);
    if (!data) {
      data = await fetchJsonOrText(urlPrev);
      setCachedData("inmet_previsao", data);
    }

    const br = data && data[codigoIBGE] ? data[codigoIBGE] : {};
    const diasKeys = Object.keys(br).sort((a, b) => {
      const [da, ma, ya] = a.split('/').map(Number);
      const [db, mb, yb] = b.split('/').map(Number);
      return ya - yb || ma - mb || da - db;
    });
        if (!diasKeys.length) throw new Error("Sem dados de previsão para Brasília");

    const hoje = br[diasKeys[0]];
        
        // CORRIGIDO: Usa 'hoje.manha.estacao' para o ícone.
        const iconEstacao = ICON_ESTACAO(hoje.manha.estacao);
        
        // CORRIGIDO: Cria a data da previsão para passar para a função da lua
        const [d, m, y] = diasKeys[0].split('/').map(Number);
        const forecastDate = new Date(y, m - 1, d);
        const faseLua = getFaseLua(forecastDate);

    // Previsão do dia
    tickerHtml += `<span class="weather-item">
                <span class="weather-label">Previsão do dia:</span>
                <span>${safe(hoje.manha.resumo)}</span> <img src="${ICON_TMAX}" class="weather-icon-tmax" alt="Temp. Máx.">Máxima: <span class="weather-max">${safe(
      hoje.manha.temp_max,
      "°C"
    )}</span>
                <img src="${ICON_TMIN}" class="weather-icon-tmin" alt="Temp. Mín.">Mínima: <span class="weather-min">${safe(
      hoje.manha.temp_min,
      "°C"
    )}</span>
                <img src="${ICON_UMAX}" class="weather-icon-umid" alt="Umidade Máx.">Umd. Máx.: <span>${safe(
      hoje.manha.umidade_max,
      "%"
    )}</span>
                <img src="${ICON_UMIN}" class="weather-icon-umid" alt="Umidade Mín.">Umd. Mín.: <span>${safe(
      hoje.manha.umidade_min,
      "%"
    )}</span>
                <img src="${ICON_NASCER}" class="weather-icon-small" alt="Nascer do Sol">
                    Nascer do Sol: ${safe(hoje.manha.nascer)}
                <img src="${ICON_OCASO}" class="weather-icon-small" alt="Pôr do Sol">
                    Pôr do Sol: ${safe(hoje.manha.ocaso)}
                    <img src="${iconEstacao}" class="weather-icon-estacao" title="${safe(hoje.manha.estacao)}" alt="Estação">Estação: ${safe(
      hoje.manha.estacao)}                
                     <span class="weather-label">Lua:</span><img src="${faseLua.iconUrl}" class="weather-icon-lua" alt="Lua" title="${safe(faseLua.name)}">
                    <span>${safe(faseLua.name)}</span>
                </span>`;

        // Previsão períodos de hoje
    ["manha", "tarde", "noite"].forEach((periodo) => {
      if (hoje[periodo]) {
        tickerHtml += `<span class="weather-item">
                            <img src="${hoje[periodo].icone}" class="weather-icon" alt="${periodo}">
                            <span class="weather-label">${capitalize(periodo)}:</span>
                        ${safe(hoje[periodo].resumo)},
                            Vento: ${safe(hoje[periodo].int_vento)} (${safe(hoje[periodo].dir_vento)})
                        </span>`;
      }
    });

    // Próximos 3 dias
    for (let i = 1; i < 4 && i < diasKeys.length; i++) {
      const dia = br[diasKeys[i]];
      const previsao = dia.manha || dia;

      tickerHtml += `<span class="weather-item">
                    <span class="weather-day">${safe(
        previsao.dia_semana || dia.dia_semana
      )}:</span>
                    <img src="${previsao.icone}" class="weather-icon" alt="${safe(previsao.dia_semana || dia.dia_semana)}">
                    <span>${safe(previsao.resumo)}</span> <img src="${ICON_TMAX}" class="weather-icon-tmax" alt="Temp. Máx">Máxima: <span class="weather-max">${safe(
          previsao.temp_max,
          "°C"
        )}</span>
                    <img src="${ICON_TMIN}" class="weather-icon-tmin" alt="Temp. Mín">Mínima: <span class="weather-min">${safe(
          previsao.temp_min,
          "°C"
        )}</span>
                    <img src="${ICON_UMAX}" class="weather-icon-umid" alt="Umidade Max">Umd. Máx.: <span>${safe(
          previsao.umidade_max, // Corrigido: sempre buscar do objeto 'dia'
          "%"
        )}</span>
                    <img src="${ICON_UMIN}" class="weather-icon-umid" alt="Umidade Min">Umd. Mín.: <span>${safe(
          previsao.umidade_min, // Corrigido: sempre buscar do objeto 'dia'
          "%"
        )}</span>
                    <img src="${ICON_WIND}" class="weather-icon-small" alt="Vento">Vento: ${safe(previsao.int_vento)} (${safe(previsao.dir_vento)}) 
                  </span>`;
    }
  } catch (e) {
    tickerHtml =
      "Erro ao carregar informações meteorológicas. " + (e.message || e);
    console.error(e);
  }

  document.getElementById("weather-ticker-content").innerHTML =
    tickerHtml;

  const ticker = document.getElementById("weather-ticker-content");
  ticker.style.animation = "none";
  ticker.style.minWidth = "unset";
  setTimeout(() => {
    const tickerWidth = ticker.scrollWidth;
    const parentWidth = ticker.parentElement.offsetWidth;
    const speedPxPerSec = 140; // Velocidade fixa de 140px/s
    const duration = (tickerWidth + parentWidth) / speedPxPerSec;
    const keyframesName = "ticker-weather-dyn";
    const styleElem = document.getElementById("ticker-style-dyn") || (() => {
      const style = document.createElement("style");
      style.id = "ticker-style-dyn";
      document.head.appendChild(style);
      return style;
    })();
        styleElem.innerHTML = `@keyframes ${keyframesName} { 0% { transform: translateX(${parentWidth}px); } 100% { transform: translateX(-${tickerWidth}px); } }`;
    ticker.style.animation = `${keyframesName} ${duration}s linear infinite`;
  }, 30);
}

    // Carrega os dados meteorológicos ao carregar a página
    document.addEventListener("DOMContentLoaded", loadWeatherData);
    // Adiciona um intervalo para recarregar os dados a cada 30 minutos
    setInterval(loadWeatherData, 30 * 60 * 1000);

  </script>
</body>

</html>